# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set ver.3.0.2
# Copyright (c) 2006-2016 Trustwave and contributors. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set is distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
#
# ------------------------------------------------------------------------

# These exclusions remedy false positives in a default Dokuwiki install.
# The exclusions are only active if crs_exclusions_dokuwiki=1 is set.
# See rule 900131 in crs-setup.conf.example for instructions.
#
# A basic example of setting it within a site's config file:
#
#  SecAction \
#    "id:900132,\
#    phase:1,\
#    nolog,\
#    pass,\
#    t:none,\
#    setvar:tx.crs_exclusions_dokuwik=1"


# If you have issues uploading/downloading files, you can relax the restrictions.
# Only do this if you have to, as changing this could make your system vulnerable.
# Rule 900240 in crs-setup.conf explains this and has examples and default values.
# Below is an example for Dokuwiki, allowing the exception for _only_ the script that does the uploading.
#
# Remember that the restricted_extensions is the *blocked* extensions (not allowed),
# which you will need to modify for your needs.


# SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php"\
#    "id:901111,\
#    phase:1,\
#    t:none,\
#    nolog,\
#    pass,\
#    chain"
#    SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
#      "t:none,\
#      tx.restricted_extensions='.bak/ .config/ .conf/ .db/ .ini/ .log/ .old/ .pass/ .pdb/ .sql/'"




SecRule &TX:crs_exclusions_dokuwiki|TX:crs_exclusions_dokuwiki "@eq 0" \
    "id:9011000,\
    phase:1,\
    t:none,\
    nolog,\
    pass,\
    skipAfter:END-DOKUWIKI"

SecRule &TX:crs_exclusions_dokuwiki|TX:crs_exclusions_dokuwiki "@eq 0" \
    "id:9011001,\
    phase:2,\
    t:none,\
    nolog,\
    pass,\
    skipAfter:END-DOKUWIKI"

# Note: I have tagged most rules by a url, and the do=action arg, in
# order to make sure we only allow that page/url.

#
# -=[ Dokuwiki Front-End ]=-
#

#
# -=[ Dokuwiki Back-End ]=-
#


# Allow pages to be edited, and ajax to save drafts.
# 
# ARGS 'wikitext', 'suffix', and 'prefix' must allow the same things,
# as the page (in part or whole) is passed via 'suffix/prefix' at times.
#  921110-921160: Allows odd characters on the page.
#  930000-933999: Allows code on page.
#  940000-942999: Allows SQL expressions on page.
# 
# Others:
#  930110;REQUEST_BODY: if there's  a /../ in the text.
#
# Also, can't specify:
#   SecRule ARGS:do "@streq edit" \
#   SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php"\
# because at times the do=edit can get dropped, so if we use
# above the edit will get blocked when the page is saved.

SecRule REQUEST_FILENAME "@rx (/doku.php|/lib/exe/ajax.php)$" \
    "id:9011100,\
    phase:2,\
    t:none,\
    nolog,\
    pass,\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "t:none,\
        chain"
    SecRule &ARGS:wikitext "@eq 1" \
        "t:none,\
        chain"
    SecRule &ARGS:suffix "@eq 1" \
        "t:none,\
        chain"
    SecRule &ARGS:prefix "@eq 1" \
        "t:none,\
        chain"
    SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
        "t:none,\
        ctl:ruleRemoveTargetByID=920230;ARGS:wikitext,\
        ctl:ruleRemoveTargetByID=921110-921160;ARGS:wikitext,\
        ctl:ruleRemoveTargetByID=930000-933999;ARGS:wikitext,\
        ctl:ruleRemoveTargetByID=940000-942999;ARGS:wikitext,\
        ctl:ruleRemoveTargetByID=920230;ARGS:suffix,\
        ctl:ruleRemoveTargetByID=921110-921160;ARGS:suffix,\
        ctl:ruleRemoveTargetByID=930000-933999;ARGS:suffix,\
        ctl:ruleRemoveTargetByID=940000-942999;ARGS:suffix,\
        ctl:ruleRemoveTargetByID=920230;ARGS:prefix,\
        ctl:ruleRemoveTargetByID=921110-921160;ARGS:prefix,\
        ctl:ruleRemoveTargetByID=930000-933999;ARGS:prefix,\
        ctl:ruleRemoveTargetByID=940000-942999;ARGS:prefix,\
        ctl:ruleRemoveTargetByID=930110;REQUEST_BODY"


# Allow it to upload files. But check for cookies just to make sure.

SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php"\
    "id:9011110,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "t:none,\
        chain"
        SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
            "t:none,\
            setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type}|application/octet-stream'"


# If it's large, turn off scanning

SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php"\
    "id:9011120,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule REQUEST_HEADERS:Content-Length "@gt 31486341" \
        "t:none,\
        ctl:requestBodyAccess=Off"


# Show the index, even if things like "postgresql" or other things show up.

SecRule REQUEST_FILENAME "@endsWith /doku.php"\
    "id:9011130,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule ARGS:do "@streq index" \
        "t:none,\
        chain"
    SecRule &ARGS:do "@eq 1" \
        "t:none,\
        ctl:ruleRemoveById=951240,\
        ctl:ruleRemoveById=953110"
        

#
# [ Login form ]
#

# User login password (optional)
#SecRule REQUEST_FILENAME "@contains /doku.php" \
#    "id:9011200,\
#    phase:1,\
#    t:none,\
#    pass,\
#    nolog,\
#    noauditlog,\
#    chain"
#    SecRule ARGS:do "@streq login" \
#        "t:none,\
#        ctl:ruleRemoveTargetByTag=CRS;ARGS:p"

# Turn off checks for 'u' and 'p' parameters.

SecRule ARGS:do "@streq login" \
   "id:9011200,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    noauditlog,\
    ctl:ruleRemoveTargetByTag=CRS;ARGS:p,\
    ctl:ruleRemoveTargetByTag=CRS;ARGS:u"


# Reset password. Turn off checks for pass1, pass1-text, pass2

SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9011210,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule ARGS:do "@streq login" \
        "t:none,\
        ctl:ruleRemoveTargetByTag=CRS;ARGS:pass1,\
        ctl:ruleRemoveTargetByTag=CRS;ARGS:pass1-text,\
        ctl:ruleRemoveTargetByTag=CRS;ARGS:pass2"


# Allow the config to be saved:
# 942200:  If the user adds "..." to tagline: ARGS:config[tagline]
# 942430:  if ARGS:config[hidepages] has pages looking like sql statements
# 942430,942440:  "--- //[[@MAIL@|@NAME@]] @DATE@//"]" in ARGS:config[signature]

SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9011370,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule ARGS:page "@streq config" \
        "t:none,\
        chain"
    SecRule &ARGS:page "@eq 1" \
        "t:none,\
        chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "t:none,\
        chain"
    SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
        "t:none,\
        ctl:ruleRemoveTargetById=920230;ARGS:config[dformat],\
        ctl:ruleRemoveTargetById=942200;ARGS:config[tagline],\
        ctl:ruleRemoveTargetById=942430;ARGS:config[hidepages],\
        ctl:ruleRemoveTargetById=942430-942440;ARGS:config[signature]"



# When the config loads after a save, it gets blocked because 
#   it has 'readdir' and lines that look like sql
# 942430,942440:  "--- //[[@MAIL@|@NAME@]] @DATE@//"]" in ARGS:config[signature]
# 951240,953110:  When the page reloads, it triggers 
#   postgress and php code disclosure rules.

SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9011380,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule ARGS:page "@streq config" \
        "t:none,\
        chain"
    SecRule &ARGS:page "@eq 1" \
        "t:none,\
        chain"
    SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
        "t:none,\
        ctl:ruleRemoveById=951240,\
        ctl:ruleRemoveById=953110"


SecMarker END-DOKUWIKI-ADMIN


SecMarker END-DOKUWIKI
